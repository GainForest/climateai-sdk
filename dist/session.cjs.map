{"version":3,"sources":["../src/_internal/server/session.ts"],"names":["jwtVerify","cookies"],"mappings":";;;;;;AAYA,IAAM,UAAA,GAAa,IAAI,WAAA,EAAY,CAAE,MAAA;AAAA,EACnC,OAAA,CAAQ,IAAI,aAAA,IAAiB;AAC/B,CAAA;AAUA,eAAe,QAAQ,KAAA,EAA8C;AACnE,EAAA,IAAI;AACF,IAAA,MAAM,EAAE,OAAA,EAAQ,GAAI,MAAMA,cAAA,CAAU,OAAO,UAAU,CAAA;AACrD,IAAA,OAAO,OAAA;AAAA,EACT,CAAA,CAAA,MAAQ;AACN,IAAA,OAAO,IAAA;AAAA,EACT;AACF;AAEA,eAAsB,qBAAA,CACpB,UAA8B,eAAA,EACC;AAC/B,EAAA,MAAM,WAAA,GAAc,MAAMC,eAAA,EAAQ;AAClC,EAAA,MAAM,gBAAA,GAAmB,WAAA,CAAY,GAAA,CAAI,CAAA,EAAG,OAAO,CAAA,QAAA,CAAU,CAAA;AAE7D,EAAA,IAAI,CAAC,gBAAA,EAAkB;AACrB,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,OAAO,MAAM,OAAA,CAAQ,gBAAA,CAAiB,KAAK,CAAA;AAC7C","file":"session.cjs","sourcesContent":["import { cookies } from \"next/headers\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport type { JwtPayload } from \"@atproto/oauth-client-node\";\nimport type { SupportedPDSDomain } from \"@/_internal/index\";\n\nexport interface StoredSession extends JwtPayload {\n  accessJwt: string;\n  refreshJwt: string;\n  did: string;\n  handle: string;\n}\n\nconst SECRET_KEY = new TextEncoder().encode(\n  process.env.COOKIE_SECRET || \"your-secret-key-min-32-chars-long\"\n);\n\nasync function encrypt(payload: StoredSession): Promise<string> {\n  return await new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(\"30d\")\n    .sign(SECRET_KEY);\n}\n\nasync function decrypt(token: string): Promise<StoredSession | null> {\n  try {\n    const { payload } = await jwtVerify(token, SECRET_KEY);\n    return payload as StoredSession;\n  } catch {\n    return null;\n  }\n}\n\nexport async function getSessionFromRequest(\n  service: SupportedPDSDomain = \"climateai.org\"\n): Promise<StoredSession | null> {\n  const cookieStore = await cookies();\n  const encryptedSession = cookieStore.get(`${service}_session`);\n\n  if (!encryptedSession) {\n    return null;\n  }\n\n  return await decrypt(encryptedSession.value);\n}\n\nexport async function saveSession(\n  session: StoredSession,\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  const encrypted = await encrypt(session);\n\n  cookieStore.set(`${service}_session`, encrypted, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 60 * 60 * 24 * 30,\n    path: \"/\",\n  });\n\n  return encrypted;\n}\n\nexport async function clearSession(\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  cookieStore.delete(`${service}_session`);\n}\n"]}