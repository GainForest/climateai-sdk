{"version":3,"sources":["../../src/_internal/utilities/atproto/getBlobUrl.ts","../../src/_internal/server/utils/claims.ts"],"names":[],"mappings":"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","file":"hypercerts.js","sourcesContent":["import {\n  type Uri as GFUri,\n  type Image as GFImage,\n  type ImageThumbnail as GFImageThumbnail,\n} from \"@/../lex-api/types/app/gainforest/common/defs\";\nimport {\n  type LargeBlob,\n  type LargeImage,\n  type SmallBlob,\n  type SmallImage,\n  type Uri,\n} from \"@/../lex-api/types/org/hypercerts/defs\";\nimport type { $Typed } from \"@/../lex-api/util\";\nimport type { BlobRefGenerator } from \"@/_internal/zod-schemas/blobref\";\nimport { BlobRef } from \"@atproto/api\";\nimport { SupportedPDSDomain } from \"../..\";\n\ntype SupportedImageData =\n  | string\n  | BlobRef\n  | BlobRefGenerator\n  // org.hypercerts.defs types\n  | $Typed<Uri | SmallImage | LargeImage | SmallBlob | LargeBlob>\n  | Uri\n  | SmallImage\n  | LargeImage\n  | SmallBlob\n  | LargeBlob\n  // app.gainforest.common.defs types\n  | $Typed<GFUri | GFImage | GFImageThumbnail>\n  | GFUri\n  | GFImage\n  | GFImageThumbnail;\n\nconst getBlobUrl = <T extends SupportedPDSDomain>(\n  did: string,\n  imageData: SupportedImageData,\n  pdsDomain: T\n) => {\n  if (typeof imageData === \"string\") {\n    const imageUrl = new URL(imageData);\n    return imageUrl.toString();\n  }\n\n  const isBlobRef =\n    imageData instanceof BlobRef ||\n    (\"ref\" in imageData && \"mimeType\" in imageData && \"size\" in imageData);\n  if (isBlobRef) {\n    const ref = imageData.ref as unknown as { $link?: string } | string;\n    const cid = typeof ref === \"string\" ? ref : (ref?.$link ?? String(ref));\n    const encodedCid = encodeURIComponent(cid);\n    return `https://${pdsDomain}/xrpc/com.atproto.sync.getBlob?did=${did}&cid=${encodedCid}`;\n  }\n\n  // Handle $Typed cases - URI types\n  if (\n    imageData.$type === \"app.gainforest.common.defs#uri\" ||\n    imageData.$type === \"org.hypercerts.defs#uri\"\n  ) {\n    return imageData.uri;\n  }\n\n  // Handle org.hypercerts.defs blob types\n  if (\n    imageData.$type === \"org.hypercerts.defs#smallBlob\" ||\n    imageData.$type === \"org.hypercerts.defs#largeBlob\"\n  ) {\n    return getBlobUrl(did, imageData.blob, pdsDomain);\n  }\n\n  // Handle org.hypercerts.defs image types (use 'image' property)\n  if (\n    imageData.$type === \"org.hypercerts.defs#smallImage\" ||\n    imageData.$type === \"org.hypercerts.defs#largeImage\"\n  ) {\n    return getBlobUrl(did, imageData.image, pdsDomain);\n  }\n\n  // Handle app.gainforest.common.defs image types (use 'file' property)\n  if (\n    imageData.$type === \"app.gainforest.common.defs#image\" ||\n    imageData.$type === \"app.gainforest.common.defs#imageThumbnail\"\n  ) {\n    return getBlobUrl(did, imageData.file, pdsDomain);\n  }\n\n  // Fallback for untyped objects - check by property presence\n  if (\"blob\" in imageData) {\n    return getBlobUrl(did, imageData.blob, pdsDomain);\n  }\n\n  if (\"image\" in imageData) {\n    return getBlobUrl(did, imageData.image, pdsDomain);\n  }\n\n  if (\"file\" in imageData) {\n    return getBlobUrl(did, imageData.file, pdsDomain);\n  }\n\n  if (\"uri\" in imageData) {\n    return imageData.uri;\n  }\n\n  // Line for compile time check that all cases are handled. THIS SHOULD NEVER BE REACHED.\n  const imageDataTypeCheck = imageData satisfies never;\n  return imageDataTypeCheck;\n};\n\nexport { getBlobUrl };\n","import type { Ecocert } from \"@/_internal/types/Ecocert\";\nimport type { OrganizationWithActivities as OrganizationWithActivitiesType } from \"@/_internal/server/routers/atproto/hypercerts/claim/activity/getAllAcrossOrgs\";\nimport { getBlobUrl } from \"@/_internal/utilities/atproto\";\nimport type { SupportedPDSDomain } from \"@/_internal/index\";\n\nexport const getEcocertsFromClaimActivities = (\n  activitiesWithOrgInfo: OrganizationWithActivitiesType[],\n  pdsDomain: SupportedPDSDomain\n): Ecocert[] => {\n  const ecocerts: Ecocert[] = [];\n  for (const activityWithOrgInfo of activitiesWithOrgInfo) {\n    const logo = activityWithOrgInfo.organizationInfo.logo;\n    const logoUrl =\n      logo ?\n        getBlobUrl(activityWithOrgInfo.repo.did, logo.image, pdsDomain)\n      : null;\n    const coverImage = activityWithOrgInfo.organizationInfo.coverImage;\n    const coverImageUrl =\n      coverImage ?\n        getBlobUrl(activityWithOrgInfo.repo.did, coverImage.image, pdsDomain)\n      : null;\n    for (const activity of activityWithOrgInfo.activities) {\n      ecocerts.push({\n        repo: {\n          did: activityWithOrgInfo.repo.did,\n        },\n        organizationInfo: {\n          name: activityWithOrgInfo.organizationInfo.displayName,\n          logoUrl: logoUrl,\n          coverImageUrl: coverImageUrl,\n        },\n        claimActivity: activity,\n      });\n    }\n  }\n  return ecocerts;\n};\n"]}