{"version":3,"sources":["../src/index.ts","../src/utilities/getBlobUrl.ts","../src/utilities/parseAtUri.ts","../src/server/trpc.ts","../src/server/session.ts","../src/utilities/transformer.ts","../src/server/routers/atproto/common/uploadFileAsBlob.ts","../src/server/routers/atproto/auth/login.ts","../src/server/routers/atproto/auth/resume.ts","../src/server/routers/atproto/auth/logout.ts","../src/server/routers/atproto/gainforest/organizationInfo/get.ts","../src/server/routers/atproto/gainforest/site/get.ts","../src/server/routers/atproto/gainforest/site/getDefault.ts","../src/server/routers/atproto/gainforest/measuredTrees/get.ts","../src/server/routers/atproto/hypercerts/claim/activity/create.ts","../src/server/routers/atproto/gainforest/organizationInfo/createOrUpdate.ts","../src/server/routers/atproto/gainforest/site/getAll.ts","../src/server/routers/atproto/gainforest/site/create.ts","../src/server/routers/atproto/gainforest/site/utils.ts","../src/server/routers/atproto/gainforest/site/update.ts","../src/server/routers/atproto/gainforest/site/setDefault.ts","../src/server/routers/atproto/gainforest/site/delete.ts","../src/server/routers/atproto/hypercerts/claim/activity/getAllAcrossOrgs.ts","../src/server/routers/atproto/hypercerts/claim/activity/getAll.ts","../src/server/routers/atproto/hypercerts/claim/activity/get.ts","../src/server/routers/atproto/hypercerts/location/get.ts","../src/server/routers/_app.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { getBlobUrl, parseAtUri } from \"./utilities\";\nimport { AppRouterFactory, type AppRouter } from \"./server/routers/_app\";\n\nconst supportedDomains = [\"climateai.org\", \"hypercerts.org\"] as const;\nexport const supportedPDSDomainSchema = z.enum(supportedDomains);\nconst supportedPDSDomainsSchema = z.array(supportedPDSDomainSchema);\nexport type SupportedPDSDomain = (typeof supportedDomains)[number];\n\nexport class ClimateAiSDK<T extends SupportedPDSDomain> {\n  public allowedPDSDomains;\n  public appRouter;\n  public getServerCaller;\n  public utilities;\n\n  constructor(_allowedPDSDomains: T[]) {\n    if (!Array.isArray(_allowedPDSDomains)) {\n      throw new Error(\"Allowed domains must be an array\");\n    } else if (_allowedPDSDomains.length === 0) {\n      throw new Error(\"There should be at least one allowed domain\");\n    }\n    if (!supportedPDSDomainsSchema.safeParse(_allowedPDSDomains).success) {\n      throw new Error(\n        \"One of the domains is not supported. Supported domains are: \" +\n          supportedDomains.join(\", \") +\n          \". Received domains: \" +\n          JSON.stringify(_allowedPDSDomains, null, 2)\n      );\n    }\n    this.allowedPDSDomains = _allowedPDSDomains;\n    const appRouterFactory = new AppRouterFactory<T>(this.allowedPDSDomains);\n    this.appRouter = appRouterFactory.appRouter;\n    this.getServerCaller = appRouterFactory.getServerCaller;\n    this.utilities = {\n      getBlobUrl: getBlobUrl<T>,\n      parseAtUri,\n    };\n  }\n}\n\nexport type { AppRouter };\nexport { createContext } from \"./server/trpc\";\n","import {\n  type LargeBlob,\n  type LargeImage,\n  type SmallBlob,\n  type SmallImage,\n  type Uri,\n} from \"@/../lex-api/types/app/gainforest/common/defs\";\nimport type { $Typed } from \"@/../lex-api/util\";\nimport type { BlobRefGenerator } from \"@/zod-schemas/blobref\";\nimport { BlobRef } from \"@atproto/api\";\nimport { SupportedPDSDomain } from \"..\";\n\nconst getBlobUrl = <T extends SupportedPDSDomain>(\n  did: string,\n  imageData:\n    | string\n    | BlobRef\n    | BlobRefGenerator\n    | $Typed<Uri | SmallImage | LargeImage | SmallBlob | LargeBlob>\n    | Uri\n    | SmallImage\n    | LargeImage\n    | SmallBlob\n    | LargeBlob,\n  pdsDomain: T\n) => {\n  if (typeof imageData === \"string\") {\n    const imageUrl = new URL(imageData);\n    return imageUrl.toString();\n  }\n\n  const isBlobRef =\n    imageData instanceof BlobRef ||\n    (\"ref\" in imageData && \"mimeType\" in imageData && \"size\" in imageData);\n  if (isBlobRef) {\n    const ref = imageData.ref as unknown as { $link?: string } | string;\n    const cid = typeof ref === \"string\" ? ref : (ref?.$link ?? String(ref));\n    const encodedCid = encodeURIComponent(cid);\n    return `https://${pdsDomain}/xrpc/com.atproto.sync.getBlob?did=${did}&cid=${encodedCid}`;\n  }\n\n  // Handle $Typed cases\n  if (imageData.$type === \"app.gainforest.common.defs#uri\") {\n    const uri = imageData.uri;\n    // TODO: handle other URI types\n    // if (uri.startsWith(\"at://\")) {\n    //   const { did: uriDid, rkey: uriRkey } = parseAtUri(uri);\n    //   return `${PDS_URL}/xrpc/com.atproto.repo.getRecord?did=${uriDid}&rkey=${uriRkey}`;\n    // }\n    return uri;\n  }\n\n  if (\n    imageData.$type === \"app.gainforest.common.defs#smallBlob\" ||\n    imageData.$type === \"app.gainforest.common.defs#largeBlob\"\n  ) {\n    const blob = imageData.blob;\n    return getBlobUrl(did, blob, pdsDomain);\n  }\n\n  if (\n    imageData.$type === \"app.gainforest.common.defs#smallImage\" ||\n    imageData.$type === \"app.gainforest.common.defs#largeImage\"\n  ) {\n    const image = imageData.image;\n    return getBlobUrl(did, image, pdsDomain);\n  }\n\n  if (\"blob\" in imageData) {\n    const blob = imageData.blob;\n    return getBlobUrl(did, blob, pdsDomain);\n  }\n\n  if (\"image\" in imageData) {\n    const image = imageData.image;\n    return getBlobUrl(did, image, pdsDomain);\n  }\n\n  if (\"uri\" in imageData) {\n    const uri = imageData.uri;\n    return uri;\n  }\n\n  // Line for compile time check that all cases are handled. THIS SHOULD NEVER BE REACHED.\n  const imageDataTypeCheck = imageData satisfies never;\n  return imageDataTypeCheck;\n};\n\nexport default getBlobUrl;\n","const parseAtUri = (atUri: string) => {\n  let cleanedAtUri = atUri.replace(\"at://\", \"\");\n\n  const splitUri = cleanedAtUri.split(\"/\");\n\n  const did = splitUri.at(0) ?? \"\";\n  const collection = splitUri.at(1) ?? \"\";\n  const rkey = splitUri.at(2) ?? \"self\";\n\n  return { did, collection, rkey };\n};\n\nexport default parseAtUri;\n","import { initTRPC, TRPCError } from \"@trpc/server\";\nimport { getSessionFromRequest } from \"./session\";\nimport { customTransformer } from \"../utilities/transformer\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport async function createContext<T extends SupportedPDSDomain>(opts?: {\n  req?: Request;\n  allowedPDSDomains: T[];\n}) {\n  // Extract session from cookies/headers\n  const session =\n    opts?.req ? await getSessionFromRequest(opts.allowedPDSDomains[0]) : null;\n\n  return {\n    session,\n  };\n}\n\nexport type TrpcContext = Awaited<ReturnType<typeof createContext>>;\n\nconst t = initTRPC.context<TrpcContext>().create({\n  transformer: customTransformer,\n});\n\nexport const createTRPCRouter = t.router;\nexport const publicProcedure = t.procedure;\n\nexport const protectedProcedure = t.procedure.use(({ ctx, next }) => {\n  if (!ctx.session) {\n    throw new TRPCError({\n      code: \"UNAUTHORIZED\",\n      message: \"You must be logged in\",\n    });\n  }\n  return next({ ctx });\n});\n","import { cookies } from \"next/headers\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport type { JwtPayload } from \"@atproto/oauth-client-node\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport interface StoredSession extends JwtPayload {\n  accessJwt: string;\n  refreshJwt: string;\n  did: string;\n  handle: string;\n}\n\nconst SECRET_KEY = new TextEncoder().encode(\n  process.env.COOKIE_SECRET || \"your-secret-key-min-32-chars-long\"\n);\n\nasync function encrypt(payload: StoredSession): Promise<string> {\n  return await new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(\"30d\")\n    .sign(SECRET_KEY);\n}\n\nasync function decrypt(token: string): Promise<StoredSession | null> {\n  try {\n    const { payload } = await jwtVerify(token, SECRET_KEY);\n    return payload as StoredSession;\n  } catch {\n    return null;\n  }\n}\n\nexport async function getSessionFromRequest(\n  service: SupportedPDSDomain = \"climateai.org\"\n): Promise<StoredSession | null> {\n  const cookieStore = await cookies();\n  const encryptedSession = cookieStore.get(`${service}_session`);\n\n  if (!encryptedSession) {\n    return null;\n  }\n\n  return await decrypt(encryptedSession.value);\n}\n\nexport async function saveSession(\n  session: StoredSession,\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  const encrypted = await encrypt(session);\n\n  cookieStore.set(`${service}_session`, encrypted, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 60 * 60 * 24 * 30,\n    path: \"/\",\n  });\n\n  return encrypted;\n}\n\nexport async function clearSession(\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  cookieStore.delete(`${service}_session`);\n}\n","// utils/transformer.ts\nimport type { DataTransformer } from \"@trpc/server\";\nimport superjson, { type SuperJSONResult } from \"superjson\";\nimport { type BlobRefGenerator, toBlobRef } from \"@/zod-schemas/blobref\";\nimport { BlobRef } from \"@atproto/api\";\nimport { isObject } from \"@/lib/isObject\";\n\ntype ReplaceType<T, U, V> =\n  // If T directly extends U, substitute to V\n  T extends U\n    ? V\n    : // If T is an array, recursively apply ReplaceType on the element type\n    T extends (infer Item)[]\n    ? ReplaceType<Item, U, V>[]\n    : // If T is an object, recursively apply ReplaceType on all properties\n    T extends object\n    ? { [K in keyof T]: ReplaceType<T[K], U, V> }\n    : // Otherwise, keep original type\n      T;\n\ntype Serialize<T> = ReplaceType<T, BlobRef, BlobRefGenerator>;\n\nconst _serialize = <T>(data: T): Serialize<T> => {\n  return JSON.parse(JSON.stringify(data)) as Serialize<T>;\n};\n\nconst _deserialize = <T>(data: Serialize<T>): T => {\n  const isObj = isObject(data);\n  if (!isObj) {\n    if (Array.isArray(data)) {\n      return data.map(_deserialize) as T;\n    }\n    return data as T;\n  }\n  if (\"$type\" in data && data.$type === \"blob\" && \"ref\" in data) {\n    try {\n      return toBlobRef(data as unknown as BlobRefGenerator) as T;\n    } catch {\n      return data as T;\n    }\n  }\n\n  const obj = data as Record<string, unknown>;\n  return Object.fromEntries(\n    Object.entries(obj).map(([key, value]) => [key, _deserialize(value)])\n  ) as T;\n};\n\nexport const customTransformer: DataTransformer = {\n  serialize: (object) => {\n    // typeof object = object\n    // This logic runs for transforming the query or mutation parameters before they are sent to the server.\n    // Conversion of object to string is automatically handled by TRPC.\n    const atprotoSerialized = _serialize(object);\n    const serializedObject = superjson.serialize(atprotoSerialized);\n    return serializedObject;\n  },\n  deserialize: <T>(object: SuperJSONResult): T => {\n    // typeof object = { json: object }\n    // This logic runs for transforming the query or mutation response before it is received by the client.\n    // The received response is automatically converted from stringified JSON to object by TRPC.\n    const superjsonDeserialized = superjson.deserialize(object) as Serialize<T>;\n    const deserializedObject = _deserialize(superjsonDeserialized);\n    // console.log(\"deserialized object\", deserializedObject);\n    return deserializedObject as T;\n  },\n};\n\nexport type SerializedSuperjson<T> = Omit<SuperJSONResult, \"json\"> & {\n  json: Serialize<T>;\n};\n\nexport const serialize = <T>(data: T) => {\n  const result = customTransformer.serialize(data);\n  return result as SerializedSuperjson<T>;\n};\n\nexport const deserialize = <T>(object: SerializedSuperjson<T>): T => {\n  return customTransformer.deserialize(object);\n};\n","import { protectedProcedure } from \"@/server/trpc\";\nimport z, { file } from \"zod\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport {\n  FileGeneratorSchema,\n  toFile,\n  type FileGenerator,\n} from \"@/zod-schemas/file\";\nimport { BlobRef, type Agent } from \"@atproto/api\";\nimport { TRPCError } from \"@trpc/server\";\n\nexport const uploadFileAsBlobPure = async (\n  file: File | FileGenerator,\n  agent: Agent\n) => {\n  let fileToUpload: File;\n  if (file instanceof File) {\n    fileToUpload = file;\n  } else {\n    fileToUpload = await toFile(file);\n  }\n  const response = await agent.uploadBlob(fileToUpload);\n\n  if (response.success !== true) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to upload file as blob.\",\n    });\n  }\n  return response.data;\n};\n\nexport const uploadFileAsBlobFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        file: FileGeneratorSchema,\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      const response = await uploadFileAsBlobPure(input.file, agent);\n\n      return response;\n    });\n};\n","import { type SupportedPDSDomain } from \"@/index\";\nimport { saveSession, type StoredSession } from \"@/server/session\";\nimport { publicProcedure } from \"@/server/trpc\";\nimport { CredentialSession } from \"@atproto/api\";\nimport { TRPCError } from \"@trpc/server\";\nimport z from \"zod\";\n\nexport const loginFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        handlePrefix: z.string().regex(/^^[a-zA-Z0-9-]+$/), // alphanumerics and hyphens only\n        service: allowedPDSDomainSchema,\n        password: z.string(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      const session = new CredentialSession(\n        new URL(`https://${input.service}`)\n      );\n      const result = await session.login({\n        identifier: `${input.handlePrefix}.${input.service}`,\n        password: input.password,\n      });\n      if (!result.success) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Login failed\",\n        });\n      }\n      const context: StoredSession = {\n        accessJwt: result.data.accessJwt,\n        refreshJwt: result.data.refreshJwt,\n        did: result.data.did,\n        handle: result.data.handle,\n      };\n      await saveSession(context, input.service);\n      return {\n        context,\n        service: input.service,\n      };\n    });\n};\n","import { type SupportedPDSDomain } from \"@/index\";\nimport { getSessionFromRequest } from \"@/server/session\";\nimport { publicProcedure } from \"@/server/trpc\";\nimport { TRPCError } from \"@trpc/server\";\nimport z from \"zod\";\n\nexport const resumeFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        service: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const session = await getSessionFromRequest(input.service);\n      if (!session) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"No session found\",\n        });\n      }\n      return {\n        context: session,\n        service: input.service,\n      };\n    });\n};\n","import { type SupportedPDSDomain } from \"@/index\";\nimport { clearSession } from \"@/server/session\";\nimport { publicProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\n\nexport const logoutFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        service: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      await clearSession(input.service);\n      return {\n        success: true,\n      };\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { XRPCError } from \"@atproto/xrpc\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport { AppGainforestOrganizationInfo } from \"@/../lex-api\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { xrpcErrorToTRPCError } from \"@/server/utils/classify-xrpc-error\";\nimport { TRPCError } from \"@trpc/server\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const getOrganizationInfoPure = async <T extends SupportedPDSDomain>(\n  did: string,\n  pdsDomain: T\n) => {\n  const agent = getReadAgent(pdsDomain);\n  console.log(\"TEMP DEBUG LOG:\", JSON.stringify({ did, pdsDomain }));\n  const getRecordPromise = agent.com.atproto.repo.getRecord({\n    collection: \"app.gainforest.organization.info\",\n    repo: did,\n    rkey: \"self\",\n  });\n  const [response, error] = await tryCatch(getRecordPromise);\n\n  if (error) {\n    if (error instanceof XRPCError) {\n      const trpcError = xrpcErrorToTRPCError(error);\n      throw trpcError;\n    } else {\n      console.error(\"getOrganizationInfo error:\", error);\n      throw new TRPCError({\n        code: \"INTERNAL_SERVER_ERROR\",\n        message: \"An unknown error occurred.\",\n      });\n    }\n  }\n\n  if (response.success !== true) {\n    console.error(\"getOrganizationInfo error: response.success is not true\");\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to get organization info.\",\n    });\n  }\n\n  validateRecordOrThrow(response.data.value, AppGainforestOrganizationInfo);\n\n  return response.data as GetRecordResponse<AppGainforestOrganizationInfo.Record>;\n};\n\nexport const getOrganizationInfoFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(z.object({ did: z.string(), pdsDomain: allowedPDSDomainSchema }))\n    .query(async ({ input }) => {\n      return await getOrganizationInfoPure(input.did, input.pdsDomain);\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { AppGainforestOrganizationSite } from \"@/../lex-api\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\n\nexport const getSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        rkey: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      const agent = getReadAgent(input.pdsDomain);\n      const response = await agent.com.atproto.repo.getRecord({\n        collection: \"app.gainforest.organization.site\",\n        repo: input.did,\n        rkey: input.rkey,\n      });\n      if (response.success !== true) {\n        throw new Error(\"Failed to get the site.\");\n      }\n      validateRecordOrThrow(response.data.value, AppGainforestOrganizationSite);\n      return response.data as GetRecordResponse<AppGainforestOrganizationSite.Record>;\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport { AppGainforestOrganizationDefaultSite } from \"@/../lex-api\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\n\nexport const getDefaultProjectSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      const agent = getReadAgent(input.pdsDomain);\n      const response = await agent.com.atproto.repo.getRecord({\n        collection: \"app.gainforest.organization.defaultSite\",\n        repo: input.did,\n        rkey: \"self\",\n      });\n      if (response.success !== true) {\n        throw new Error(\"Failed to get default project site\");\n      }\n      validateRecordOrThrow(\n        response.data.value,\n        AppGainforestOrganizationDefaultSite\n      );\n      return response.data as GetRecordResponse<AppGainforestOrganizationDefaultSite.Record>;\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport { AppGainforestOrganizationObservationsMeasuredTreesCluster as MeasuredTreesCluster } from \"@/../lex-api\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\n\nexport const getMeasuredTreesFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      const agent = getReadAgent(input.pdsDomain);\n      const nsid: MeasuredTreesCluster.Record[\"$type\"] =\n        \"app.gainforest.organization.observations.measuredTreesCluster\";\n      const response = await agent.com.atproto.repo.getRecord({\n        collection: nsid,\n        repo: input.did,\n        rkey: \"self\",\n      });\n      if (response.success !== true) {\n        throw new Error(\"Failed to get measured trees\");\n      }\n      validateRecordOrThrow(response.data.value, MeasuredTreesCluster);\n      return response.data as GetRecordResponse<MeasuredTreesCluster.Record>;\n    });\n};\n","import { protectedProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { Agent } from \"@atproto/api\";\nimport {\n  AppCertifiedLocation,\n  OrgHypercertsClaimActivity,\n  OrgHypercertsClaimContribution,\n} from \"@/../lex-api\";\nimport { toBlobRef, toBlobRefGenerator } from \"@/zod-schemas/blobref\";\nimport { type FileGenerator, FileGeneratorSchema } from \"@/zod-schemas/file\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nconst uploadFile = async (fileGenerator: FileGenerator, agent: Agent) => {\n  const file = new File(\n    [Buffer.from(fileGenerator.dataBase64, \"base64\")],\n    fileGenerator.name,\n    { type: fileGenerator.type }\n  );\n  const response = await agent.uploadBlob(file);\n  return toBlobRefGenerator(response.data.blob);\n};\n\nexport const createClaimActivityFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        activity: z.object({\n          title: z.string(),\n          shortDescription: z.string(),\n          description: z.string().optional(),\n          workScopes: z.array(z.string()),\n          startDate: z.string(),\n          endDate: z.string(),\n        }),\n        uploads: z.object({\n          image: FileGeneratorSchema,\n          contributors: z.array(z.string()).refine((v) => v.length > 0, {\n            message: \"At least one contribution is required\",\n          }),\n          siteAtUri: z.string(),\n        }),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      const did = agent.did;\n      if (!did) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"You are not authorized to perform this action.\",\n        });\n      }\n\n      // Generate record data for validation before writing to the PDS:\n      // Location record\n      const locationNSID = \"app.certified.location\";\n      const location: AppCertifiedLocation.Record = {\n        $type: locationNSID,\n        lpVersion: \"1.0.0\",\n        srs: \"https://epsg.io/3857\",\n        locationType: \"geojson\",\n        location: {\n          $type: \"org.hypercerts.defs#uri\",\n          uri: input.uploads.siteAtUri,\n        },\n        createdAt: new Date().toISOString(),\n      };\n      const validatedLocation = validateRecordOrThrow(\n        location,\n        AppCertifiedLocation\n      );\n\n      // Activity record\n      const activityNSID = \"org.hypercerts.claim.activity\";\n      const activity: OrgHypercertsClaimActivity.Record = {\n        $type: activityNSID,\n        title: input.activity.title,\n        shortDescription: input.activity.shortDescription,\n        description: input.activity.description,\n        // These will be set after the records are created:\n        image: undefined,\n        location: undefined,\n        contributions: undefined,\n        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        workScope: {\n          $type: \"org.hypercerts.claim.activity#workScope\",\n          anyOf: input.activity.workScopes,\n        },\n        startDate: input.activity.startDate,\n        endDate: input.activity.endDate,\n        createdAt: new Date().toISOString(),\n      };\n      const validatedActivity = validateRecordOrThrow(\n        activity,\n        OrgHypercertsClaimActivity\n      );\n\n      // Contribution record\n      const contributionNSID = \"org.hypercerts.claim.contribution\";\n      const contribution: OrgHypercertsClaimContribution.Record = {\n        $type: \"org.hypercerts.claim.contribution\",\n        // Use dummy hypercert reference for now because the activity record is not yet created:\n        hypercert: {\n          $type: \"com.atproto.repo.strongRef\",\n          uri: `at://${did}/org.hypercerts.claim.activity/0`,\n          cid: \"bafkreifj2t4px2uizj25ml53axem47yfhpgsx72ekjrm2qyymcn5ifz744\",\n        },\n        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        role: \"Contributor\",\n        contributors: input.uploads.contributors,\n        createdAt: new Date().toISOString(),\n      };\n      const validatedContribution = validateRecordOrThrow(\n        contribution,\n        OrgHypercertsClaimContribution\n      );\n\n      // Write records to the PDS\n      // 1. Write location to the PDS\n      const locationWriteResponse = await agent.com.atproto.repo.createRecord({\n        repo: did,\n        collection: locationNSID,\n        record: validatedLocation,\n      });\n      if (locationWriteResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to write location record\",\n        });\n      }\n      // 2. Upload image to the PDS\n      const imageBlobRef = await uploadFile(input.uploads.image, agent);\n      // 3. Write activity to the PDS\n      const activityResponse = await agent.com.atproto.repo.createRecord({\n        repo: did,\n        collection: activityNSID,\n        record: {\n          ...validatedActivity,\n          image: {\n            $type: \"org.hypercerts.defs#smallImage\",\n            image: toBlobRef(imageBlobRef),\n          },\n          location: {\n            $type: \"com.atproto.repo.strongRef\",\n            uri: locationWriteResponse.data.uri,\n            cid: locationWriteResponse.data.cid,\n          },\n        } satisfies OrgHypercertsClaimActivity.Record,\n      });\n      if (activityResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to write activity record\",\n        });\n      }\n      // 4. Write contribution to the PDS\n      const contributionWriteResponse =\n        await agent.com.atproto.repo.createRecord({\n          repo: did,\n          collection: contributionNSID,\n          record: {\n            ...validatedContribution,\n            hypercert: {\n              $type: \"com.atproto.repo.strongRef\",\n              uri: activityResponse.data.uri,\n              cid: activityResponse.data.cid,\n            },\n          } satisfies OrgHypercertsClaimContribution.Record,\n        });\n      if (contributionWriteResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to write contribution record\",\n        });\n      }\n\n      return activityResponse;\n    });\n};\n","import { protectedProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\nimport { AppGainforestOrganizationInfo } from \"@/../lex-api\";\nimport type { PutRecordResponse } from \"@/server/utils/response-types\";\nimport { TRPCError } from \"@trpc/server\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { FileGeneratorSchema } from \"@/zod-schemas/file\";\nimport { BlobRefGeneratorSchema, toBlobRef } from \"@/zod-schemas/blobref\";\nimport { uploadFileAsBlobPure } from \"../../common/uploadFileAsBlob\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const createOrUpdateOrganizationInfoFactory = <\n  T extends SupportedPDSDomain,\n>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        info: z.object({\n          displayName: z.string(),\n          shortDescription: z.string(),\n          longDescription: z.string(),\n          website: z.string().optional(),\n          logo: BlobRefGeneratorSchema.optional(),\n          coverImage: BlobRefGeneratorSchema.optional(),\n          objectives: z.array(\n            z.enum([\n              \"Conservation\",\n              \"Research\",\n              \"Education\",\n              \"Community\",\n              \"Other\",\n            ])\n          ),\n          startDate: z.string().optional(),\n          country: z.string(),\n          visibility: z.enum([\"Public\", \"Hidden\"]),\n        }),\n        uploads: z\n          .object({\n            logo: FileGeneratorSchema.optional(),\n            coverImage: FileGeneratorSchema.optional(),\n          })\n          .optional(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      const logoBlob =\n        input.uploads?.logo ?\n          (await uploadFileAsBlobPure(input.uploads.logo, agent)).blob\n        : input.info.logo ? toBlobRef(input.info.logo)\n        : undefined;\n      const coverImageBlob =\n        input.uploads?.coverImage ?\n          (await uploadFileAsBlobPure(input.uploads.coverImage, agent)).blob\n        : input.info.coverImage ? toBlobRef(input.info.coverImage)\n        : undefined;\n\n      const info: AppGainforestOrganizationInfo.Record = {\n        $type: \"app.gainforest.organization.info\",\n        displayName: input.info.displayName,\n        shortDescription: input.info.shortDescription,\n        longDescription: input.info.longDescription,\n        website: input.info.website ? input.info.website : undefined,\n        logo:\n          logoBlob ?\n            {\n              $type: \"app.gainforest.common.defs#smallImage\",\n              image: logoBlob,\n            }\n          : undefined,\n        coverImage:\n          coverImageBlob ?\n            {\n              $type: \"app.gainforest.common.defs#smallImage\",\n              image: coverImageBlob,\n            }\n          : undefined,\n        objectives: input.info.objectives,\n        startDate: input.info.startDate ? input.info.startDate : undefined,\n        country: input.info.country,\n        visibility: input.info.visibility,\n        createdAt: new Date().toISOString(),\n      };\n\n      validateRecordOrThrow(info, AppGainforestOrganizationInfo);\n\n      const response = await agent.com.atproto.repo.putRecord({\n        repo: input.did,\n        collection: \"app.gainforest.organization.info\",\n        record: info,\n        rkey: \"self\",\n      });\n\n      if (response.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to update organization info\",\n        });\n      }\n\n      return {\n        ...response.data,\n        value: info,\n      } as PutRecordResponse<AppGainforestOrganizationInfo.Record>;\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport {\n  AppGainforestOrganizationDefaultSite,\n  AppGainforestOrganizationSite,\n} from \"@/../lex-api\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { XRPCError } from \"@atproto/xrpc\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { xrpcErrorToTRPCError } from \"@/server/utils/classify-xrpc-error\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\n\nexport const getAllSitesFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(z.object({ did: z.string(), pdsDomain: allowedPDSDomainSchema }))\n    .query(async ({ input }) => {\n      const agent = getReadAgent(input.pdsDomain);\n      const listSitesTryCatchPromise = tryCatch(\n        agent.com.atproto.repo.listRecords({\n          collection: \"app.gainforest.organization.site\",\n          repo: input.did,\n        })\n      );\n      const getDefaultSiteTryCatchPromise = tryCatch(\n        agent.com.atproto.repo.getRecord({\n          collection: \"app.gainforest.organization.defaultSite\",\n          repo: input.did,\n          rkey: \"self\",\n        })\n      );\n\n      const [\n        [listSitesResponse, errorListSites],\n        [getDefaultSiteResponse, errorGetDefaultSite],\n      ] = await Promise.all([\n        listSitesTryCatchPromise,\n        getDefaultSiteTryCatchPromise,\n      ]);\n\n      if (errorListSites) {\n        if (errorListSites instanceof XRPCError) {\n          const trpcError = xrpcErrorToTRPCError(errorListSites);\n          throw trpcError;\n        }\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"An unknown error occurred.\",\n        });\n      } else if (listSitesResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"An unknown error occurred.\",\n        });\n      }\n\n      const validRecords = listSitesResponse.data.records\n        .map((record) => {\n          const result = AppGainforestOrganizationSite.validateRecord(\n            record.value\n          );\n          if (result.success) return record;\n          return null;\n        })\n        .filter(\n          (record) => record !== null\n        ) as GetRecordResponse<AppGainforestOrganizationSite.Record>[];\n\n      let defaultSite = null;\n      if (getDefaultSiteResponse) {\n        defaultSite =\n          getDefaultSiteResponse.data as GetRecordResponse<AppGainforestOrganizationDefaultSite.Record>;\n        try {\n          validateRecordOrThrow(\n            defaultSite.value,\n            AppGainforestOrganizationDefaultSite\n          );\n        } catch {\n          defaultSite = null;\n        }\n      }\n\n      return {\n        sites: validRecords,\n        defaultSite,\n      };\n    });\n};\n","import { protectedProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { AppGainforestOrganizationSite } from \"@/../lex-api\";\nimport { FileGeneratorSchema, toFile } from \"@/zod-schemas/file\";\nimport { TRPCError } from \"@trpc/server\";\nimport { computeGeojsonFile, fetchGeojsonFromUrl } from \"./utils\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const createSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        rkey: z.string().optional(),\n        site: z.object({\n          name: z.string().min(1),\n        }),\n        uploads: z.object({\n          shapefile: z.union([z.url(), FileGeneratorSchema]),\n        }),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      if (!agent.did) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"You are not authenticated\",\n        });\n      }\n\n      // If the site is a string, it is a URI, so fetch the file from the URI\n      const file =\n        typeof input.uploads.shapefile === \"string\" ?\n          await fetchGeojsonFromUrl(input.uploads.shapefile)\n        : await toFile(input.uploads.shapefile);\n\n      const { lat, lon, area } = await computeGeojsonFile(file);\n\n      const geojsonUploadResponse = await agent.uploadBlob(file);\n      const geojsonBlobRef = geojsonUploadResponse.data.blob;\n\n      const nsid: AppGainforestOrganizationSite.Record[\"$type\"] =\n        \"app.gainforest.organization.site\";\n      const site: AppGainforestOrganizationSite.Record = {\n        $type: nsid,\n        name: input.site.name,\n        lat: lat,\n        lon: lon,\n        area: area,\n        shapefile: {\n          $type: \"app.gainforest.common.defs#smallBlob\",\n          blob: geojsonBlobRef,\n        },\n        createdAt: new Date().toISOString(),\n      };\n\n      const validationResult =\n        AppGainforestOrganizationSite.validateRecord(site);\n      if (!validationResult.success) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: validationResult.error.message,\n        });\n      }\n\n      const creationResponse = await agent.com.atproto.repo.createRecord({\n        collection: nsid,\n        repo: agent.did,\n        record: site,\n        rkey: input.rkey,\n      });\n\n      if (creationResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to add new site\",\n        });\n      }\n\n      return creationResponse.data;\n    });\n};\n","import type { GeoJsonObject } from \"geojson\";\nimport { TRPCError } from \"@trpc/server\";\nimport { validateGeojsonOrThrow } from \"@/lib/geojson/validate\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { computePolygonMetrics } from \"@/lib/geojson/computations\";\n\nexport async function fetchGeojsonFromUrl(url: string) {\n  const response = await fetch(url);\n  if (!response.ok) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to fetch site\",\n    });\n  }\n  const blob = await response.blob();\n  if (blob.type !== \"application/geo+json\") {\n    throw new TRPCError({\n      code: \"BAD_REQUEST\",\n      message: \"Site must be a GeoJSON file\",\n    });\n  }\n  const file = new File([blob], \"site.geojson\", {\n    type: blob.type,\n  });\n  return file;\n}\n\nexport async function computeGeojsonFile(file: File) {\n  if (file.type !== \"application/geo+json\") {\n    throw new TRPCError({\n      code: \"BAD_REQUEST\",\n      message: \"Site must be a GeoJSON file\",\n    });\n  }\n\n  const geojsonText = await file.text();\n  const geojson = JSON.parse(geojsonText);\n  const [validatedGeojsonObject, geojsonValidationError] = await tryCatch(\n    new Promise<GeoJsonObject>((r) => r(validateGeojsonOrThrow(geojson)))\n  );\n\n  if (geojsonValidationError) {\n    throw new TRPCError({\n      code: \"BAD_REQUEST\",\n      message: \"Invalid GeoJSON file: \" + geojsonValidationError.message,\n    });\n  }\n\n  const polygonMetrics = computePolygonMetrics(validatedGeojsonObject);\n  const lat = polygonMetrics.centroid?.lat;\n  const lon = polygonMetrics.centroid?.lon;\n  const area = polygonMetrics.areaHectares;\n  if (!lat || !lon || !area) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to process the geojson data.\",\n    });\n  }\n\n  return {\n    lat: lat.toFixed(6),\n    lon: lon.toFixed(6),\n    area: area.toFixed(2),\n  };\n}\n","import { protectedProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { AppGainforestOrganizationSite } from \"@/../lex-api\";\nimport { BlobRefGeneratorSchema, toBlobRef } from \"@/zod-schemas/blobref\";\nimport { FileGeneratorSchema, toFile } from \"@/zod-schemas/file\";\nimport { TRPCError } from \"@trpc/server\";\nimport { computeGeojsonFile, fetchGeojsonFromUrl } from \"./utils\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport {\n  type SmallBlob,\n  type Uri,\n} from \"@/../lex-api/types/app/gainforest/common/defs\";\nimport type { $Typed } from \"@/../lex-api/util\";\n\nexport const updateSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        rkey: z.string(),\n        site: z.object({\n          name: z.string().min(1),\n          shapefile: z\n            .object({\n              $type: z.literal(\"app.gainforest.common.defs#smallBlob\"),\n              blob: BlobRefGeneratorSchema,\n            })\n            .optional(),\n          lat: z.string(),\n          lon: z.string(),\n          area: z.string(),\n        }),\n        uploads: z\n          .object({\n            shapefile: FileGeneratorSchema.optional(),\n          })\n          .optional(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      if (!agent.did) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"You are not authenticated\",\n        });\n      }\n\n      let file: File | null = null;\n      // Upload the shapefile if provided\n      if (input.uploads) {\n        if (input.uploads.shapefile === undefined) {\n          file = null;\n        } else {\n          file = await toFile(input.uploads.shapefile);\n        }\n      }\n\n      // Compute the lat, lon, and area from the shapefile\n      let lat: string;\n      let lon: string;\n      let area: string;\n      let shapefile: SmallBlob;\n      if (file !== null) {\n        const computed = await computeGeojsonFile(file);\n        const geojsonUploadResponse = await agent.uploadBlob(file);\n        shapefile = {\n          $type: \"app.gainforest.common.defs#smallBlob\",\n          blob: geojsonUploadResponse.data.blob,\n        };\n        lat = computed.lat;\n        lon = computed.lon;\n        area = computed.area;\n      } else if (input.site.shapefile) {\n        shapefile = {\n          $type: \"app.gainforest.common.defs#smallBlob\",\n          blob: toBlobRef(input.site.shapefile.blob),\n        };\n        lat = input.site.lat;\n        lon = input.site.lon;\n        area = input.site.area;\n      } else {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"No shapefile provided\",\n        });\n      }\n\n      const nsid: AppGainforestOrganizationSite.Record[\"$type\"] =\n        \"app.gainforest.organization.site\";\n      const site: AppGainforestOrganizationSite.Record = {\n        $type: nsid,\n        name: input.site.name,\n        lat: lat,\n        lon: lon,\n        area: area,\n        shapefile,\n        createdAt: new Date().toISOString(),\n      };\n\n      const validationResult =\n        AppGainforestOrganizationSite.validateRecord(site);\n      if (!validationResult.success) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: validationResult.error.message,\n        });\n      }\n\n      const updateResponse = await agent.com.atproto.repo.putRecord({\n        collection: nsid,\n        repo: agent.did,\n        record: site,\n        rkey: input.rkey,\n      });\n\n      if (updateResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to update site\",\n        });\n      }\n\n      return updateResponse.data;\n    });\n};\n","import { protectedProcedure } from \"@/server/trpc\";\nimport z from \"zod\";\nimport {\n  AppGainforestOrganizationDefaultSite,\n  AppGainforestOrganizationSite,\n} from \"@/../lex-api\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { TRPCError } from \"@trpc/server\";\nimport parseAtUri from \"@/utilities/parseAtUri\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const setDefaultSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({\n        siteAtUri: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      if (!agent.did) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"You are not authenticated\",\n        });\n      }\n\n      const siteUri = input.siteAtUri;\n      const siteNSID: AppGainforestOrganizationSite.Record[\"$type\"] =\n        \"app.gainforest.organization.site\";\n      if (!(siteUri.startsWith(`at://`) && siteUri.includes(siteNSID))) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"Invalid site URI\",\n        });\n      }\n\n      const site = await agent.com.atproto.repo.getRecord({\n        collection: siteNSID,\n        repo: agent.did,\n        rkey: parseAtUri(siteUri).rkey,\n      });\n      if (site.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to get site\",\n        });\n      }\n\n      const defaultSiteNSID: AppGainforestOrganizationDefaultSite.Record[\"$type\"] =\n        \"app.gainforest.organization.defaultSite\";\n      const defaultSite: AppGainforestOrganizationDefaultSite.Record = {\n        $type: defaultSiteNSID,\n        site: siteUri,\n        createdAt: new Date().toISOString(),\n      };\n      validateRecordOrThrow(defaultSite, AppGainforestOrganizationDefaultSite);\n      const updateDefaultSiteResponse = await agent.com.atproto.repo.putRecord({\n        collection: defaultSiteNSID,\n        repo: agent.did,\n        rkey: \"self\",\n        record: defaultSite,\n      });\n\n      if (updateDefaultSiteResponse.success !== true) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to update default site\",\n        });\n      }\n\n      return updateDefaultSiteResponse.data;\n    });\n};\n","import { AppGainforestOrganizationDefaultSite } from \"@/../lex-api\";\nimport { protectedProcedure } from \"@/server/trpc\";\nimport { getWriteAgent } from \"@/server/utils/agent\";\nimport { TRPCError } from \"@trpc/server\";\nimport z from \"zod\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport { parseAtUri } from \"@/utilities\";\n\nexport const deleteSiteFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return protectedProcedure\n    .input(\n      z.object({ siteAtUri: z.string(), pdsDomain: allowedPDSDomainSchema })\n    )\n    .mutation(async ({ input }) => {\n      const agent = await getWriteAgent(input.pdsDomain);\n      if (!agent.did) {\n        throw new TRPCError({\n          code: \"UNAUTHORIZED\",\n          message: \"You are not authenticated\",\n        });\n      }\n\n      try {\n        // Check if the site is the default site\n        const defaultSiteNSID: AppGainforestOrganizationDefaultSite.Record[\"$type\"] =\n          \"app.gainforest.organization.defaultSite\";\n        const defaultSiteResponse = await agent.com.atproto.repo.getRecord({\n          collection: defaultSiteNSID,\n          repo: agent.did,\n          rkey: \"self\",\n        });\n        if (defaultSiteResponse.success !== true)\n          throw Error(\"Failed to get default site\");\n        validateRecordOrThrow(\n          defaultSiteResponse.data.value,\n          AppGainforestOrganizationDefaultSite\n        );\n        const defaultSite = defaultSiteResponse.data\n          .value as AppGainforestOrganizationDefaultSite.Record;\n        if (defaultSite.site === input.siteAtUri) throw new Error(\"Equal\");\n      } catch (error) {\n        // Only take action if the default site is determined and equals the site to be deleted\n        if (error instanceof Error && error.message === \"Equal\") {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: \"Cannot delete default site\",\n          });\n        }\n      }\n\n      const deletionResponse = await agent.com.atproto.repo.deleteRecord({\n        collection: \"app.gainforest.organization.site\",\n        repo: agent.did,\n        rkey: parseAtUri(input.siteAtUri).rkey,\n      });\n      if (deletionResponse.success !== true)\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to delete site\",\n        });\n\n      return deletionResponse.data;\n    });\n};\n","import { tryCatch } from \"@/lib/tryCatch\";\nimport { publicProcedure } from \"@/server/trpc\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { z } from \"zod\";\nimport { TRPCError } from \"@trpc/server\";\nimport { getOrganizationInfoPure } from \"../../../gainforest/organizationInfo/get\";\nimport { getAllClaimActivitiesPure } from \"./getAll\";\nimport { type Repo } from \"@atproto/api/dist/client/types/com/atproto/sync/listRepos\";\nimport {\n  AppGainforestOrganizationInfo,\n  OrgHypercertsClaimActivity,\n} from \"@/../lex-api\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport type OrganizationWithActivities = {\n  repo: Repo;\n  organizationInfo: AppGainforestOrganizationInfo.Record;\n  activities: GetRecordResponse<OrgHypercertsClaimActivity.Record>[];\n};\n\nexport const getAllClaimActivitiesAcrossOrganizationsFactory = <\n  T extends SupportedPDSDomain,\n>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(z.object({ pdsDomain: allowedPDSDomainSchema }))\n    .query(async ({ input }) => {\n      const agent = getReadAgent(input.pdsDomain);\n\n      // Get all the repositories\n      const [repositoriesListResponse, repositoriesListFetchError] =\n        await tryCatch(\n          agent.com.atproto.sync.listRepos({\n            limit: 100,\n          })\n        );\n      if (\n        repositoriesListFetchError ||\n        repositoriesListResponse.success !== true\n      ) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to fetch repositories list\",\n        });\n      }\n      const repositoriesList = repositoriesListResponse.data.repos;\n\n      // Filter the repositories that are organizations\n      const [organizationRepositories, organizationsFetchError] =\n        await tryCatch(\n          Promise.all(\n            repositoriesList.map(async (repo) => {\n              const [organizationInfoResponse, organizationInfoFetchError] =\n                await tryCatch(\n                  getOrganizationInfoPure(repo.did, input.pdsDomain)\n                );\n              if (organizationInfoFetchError) {\n                return null;\n              }\n              return {\n                repo: repo,\n                organizationInfo: organizationInfoResponse.value,\n              };\n            })\n          )\n        );\n      if (organizationsFetchError) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to fetch organizations list\",\n        });\n      }\n      const validOrganizationRepositories = organizationRepositories.filter(\n        (org): org is NonNullable<typeof org> => org !== null\n      );\n\n      // Get all the claim activities for the organizations\n      const [activities, activitiesFetchError] = await tryCatch(\n        Promise.all(\n          validOrganizationRepositories.map(async (organization) => {\n            const [activitiesResponse, activitiesFetchError] = await tryCatch(\n              getAllClaimActivitiesPure(organization.repo.did, input.pdsDomain)\n            );\n            if (activitiesFetchError) {\n              return null;\n            }\n            return {\n              repo: organization.repo,\n              activities: activitiesResponse.activities,\n              organizationInfo: organization.organizationInfo,\n            };\n          })\n        )\n      );\n      if (activitiesFetchError) {\n        throw new TRPCError({\n          code: \"INTERNAL_SERVER_ERROR\",\n          message: \"Failed to fetch activities list\",\n        });\n      }\n\n      const validActivities = activities.filter(\n        (activity): activity is NonNullable<typeof activity> =>\n          activity !== null\n      );\n      return validActivities satisfies OrganizationWithActivities[];\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport { TRPCError } from \"@trpc/server\";\nimport { OrgHypercertsClaimActivity } from \"@/../lex-api\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { XRPCError } from \"@atproto/xrpc\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { xrpcErrorToTRPCError } from \"@/server/utils/classify-xrpc-error\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const getAllClaimActivitiesPure = async <T extends SupportedPDSDomain>(\n  did: string,\n  pdsDomain: T\n) => {\n  const activityNSID: OrgHypercertsClaimActivity.Record[\"$type\"] =\n    \"org.hypercerts.claim.activity\";\n  const agent = getReadAgent(pdsDomain);\n  const [listClaimActivitiesResponse, errorListClaimActivities] =\n    await tryCatch(\n      agent.com.atproto.repo.listRecords({\n        collection: activityNSID,\n        repo: did,\n      })\n    );\n\n  if (errorListClaimActivities) {\n    if (errorListClaimActivities instanceof XRPCError) {\n      const trpcError = xrpcErrorToTRPCError(errorListClaimActivities);\n      throw trpcError;\n    }\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"An unknown error occurred.\",\n    });\n  } else if (listClaimActivitiesResponse.success !== true) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"An unknown error occurred.\",\n    });\n  }\n\n  const validRecords = listClaimActivitiesResponse.data.records\n    .map((record) => {\n      try {\n        validateRecordOrThrow(record.value, OrgHypercertsClaimActivity);\n        return record;\n      } catch {\n        return null;\n      }\n    })\n    .filter(\n      (record) => record !== null\n    ) as GetRecordResponse<OrgHypercertsClaimActivity.Record>[];\n\n  return {\n    activities: validRecords,\n  };\n};\n\nexport const getAllClaimActivitiesFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      return await getAllClaimActivitiesPure(input.did, input.pdsDomain);\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { XRPCError } from \"@atproto/xrpc\";\nimport type { GetRecordResponse } from \"@/server/utils/response-types\";\nimport { OrgHypercertsClaimActivity } from \"@/../lex-api\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { xrpcErrorToTRPCError } from \"@/server/utils/classify-xrpc-error\";\nimport { TRPCError } from \"@trpc/server\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const getClaimActivityPure = async <T extends SupportedPDSDomain>(\n  did: string,\n  rkey: string,\n  pdsDomain: T\n) => {\n  const agent = getReadAgent(pdsDomain);\n  const nsid: OrgHypercertsClaimActivity.Record[\"$type\"] =\n    \"org.hypercerts.claim.activity\";\n  const getRecordPromise = agent.com.atproto.repo.getRecord({\n    collection: nsid,\n    repo: did,\n    rkey: rkey,\n  });\n  const [response, error] = await tryCatch(getRecordPromise);\n\n  if (error) {\n    if (error instanceof XRPCError) {\n      const trpcError = xrpcErrorToTRPCError(error);\n      throw trpcError;\n    } else {\n      throw new TRPCError({\n        code: \"INTERNAL_SERVER_ERROR\",\n        message: \"An unknown error occurred.\",\n      });\n    }\n  }\n\n  if (response.success !== true) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to get organization info.\",\n    });\n  }\n\n  validateRecordOrThrow(response.data.value, OrgHypercertsClaimActivity);\n\n  return response.data as GetRecordResponse<OrgHypercertsClaimActivity.Record>;\n};\n\nexport const getCliamActivityFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        rkey: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      return await getClaimActivityPure(input.did, input.rkey, input.pdsDomain);\n    });\n};\n","import { publicProcedure } from \"@/server/trpc\";\nimport { z } from \"zod\";\nimport { tryCatch } from \"@/lib/tryCatch\";\nimport { XRPCError } from \"@atproto/xrpc\";\nimport { type GetRecordResponse } from \"@/server/utils/response-types\";\nimport { AppCertifiedLocation } from \"@/../lex-api\";\nimport { getReadAgent } from \"@/server/utils/agent\";\nimport { xrpcErrorToTRPCError } from \"@/server/utils/classify-xrpc-error\";\nimport { TRPCError } from \"@trpc/server\";\nimport { validateRecordOrThrow } from \"@/server/utils/validate-record-or-throw\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport const getCertifiedLocationPure = async <T extends SupportedPDSDomain>(\n  did: string,\n  rkey: string,\n  pdsDomain: T\n) => {\n  const agent = getReadAgent(pdsDomain);\n  const getRecordPromise = agent.com.atproto.repo.getRecord({\n    collection: \"app.certified.location\",\n    repo: did,\n    rkey: rkey,\n  });\n  const [response, error] = await tryCatch(getRecordPromise);\n\n  if (error) {\n    if (error instanceof XRPCError) {\n      const trpcError = xrpcErrorToTRPCError(error);\n      throw trpcError;\n    } else {\n      throw new TRPCError({\n        code: \"INTERNAL_SERVER_ERROR\",\n        message: \"An unknown error occurred.\",\n      });\n    }\n  }\n\n  if (response.success !== true) {\n    throw new TRPCError({\n      code: \"INTERNAL_SERVER_ERROR\",\n      message: \"Failed to get organization info.\",\n    });\n  }\n\n  validateRecordOrThrow(response.data.value, AppCertifiedLocation);\n\n  return response.data as GetRecordResponse<AppCertifiedLocation.Record>;\n};\n\nexport const getCertifiedLocationFactory = <T extends SupportedPDSDomain>(\n  allowedPDSDomainSchema: z.ZodEnum<Record<T, T>>\n) => {\n  return publicProcedure\n    .input(\n      z.object({\n        did: z.string(),\n        rkey: z.string(),\n        pdsDomain: allowedPDSDomainSchema,\n      })\n    )\n    .query(async ({ input }) => {\n      return await getCertifiedLocationPure(\n        input.did,\n        input.rkey,\n        input.pdsDomain\n      );\n    });\n};\n","import { createContext, createTRPCRouter, publicProcedure } from \"../trpc\";\nimport { uploadFileAsBlobFactory } from \"./atproto/common/uploadFileAsBlob\";\nimport { loginFactory } from \"./atproto/auth/login\";\nimport { resumeFactory } from \"./atproto/auth/resume\";\nimport { logoutFactory } from \"./atproto/auth/logout\";\nimport { getOrganizationInfoFactory } from \"./atproto/gainforest/organizationInfo/get\";\nimport { getSiteFactory } from \"./atproto/gainforest/site/get\";\nimport { getDefaultProjectSiteFactory } from \"./atproto/gainforest/site/getDefault\";\nimport { getMeasuredTreesFactory } from \"./atproto/gainforest/measuredTrees/get\";\nimport { createClaimActivityFactory } from \"./atproto/hypercerts/claim/activity/create\";\nimport { createOrUpdateOrganizationInfoFactory } from \"./atproto/gainforest/organizationInfo/createOrUpdate\";\nimport { getAllSitesFactory } from \"./atproto/gainforest/site/getAll\";\nimport { createSiteFactory } from \"./atproto/gainforest/site/create\";\nimport { updateSiteFactory } from \"./atproto/gainforest/site/update\";\nimport { setDefaultSiteFactory } from \"./atproto/gainforest/site/setDefault\";\nimport { deleteSiteFactory } from \"./atproto/gainforest/site/delete\";\nimport { getAllClaimActivitiesAcrossOrganizationsFactory } from \"./atproto/hypercerts/claim/activity/getAllAcrossOrgs\";\nimport { getCliamActivityFactory } from \"./atproto/hypercerts/claim/activity/get\";\nimport { getCertifiedLocationFactory } from \"./atproto/hypercerts/location/get\";\nimport type { SupportedPDSDomain } from \"@/index\";\nimport z from \"zod\";\n\nexport class AppRouterFactory<T extends SupportedPDSDomain> {\n  public allowedPDSDomains;\n  public allowedPDSDomainSchema;\n  public appRouter;\n\n  constructor(_allowedPDSDomains: T[]) {\n    this.allowedPDSDomains = _allowedPDSDomains;\n    this.allowedPDSDomainSchema = z.enum(this.allowedPDSDomains);\n\n    this.appRouter = createTRPCRouter({\n      health: publicProcedure.query(() => ({ status: \"ok\" })),\n      common: {\n        uploadFileAsBlob: uploadFileAsBlobFactory(this.allowedPDSDomainSchema),\n      },\n      auth: {\n        login: loginFactory(this.allowedPDSDomainSchema),\n        resume: resumeFactory(this.allowedPDSDomainSchema),\n        logout: logoutFactory(this.allowedPDSDomainSchema),\n      },\n      gainforest: {\n        organization: {\n          info: {\n            get: getOrganizationInfoFactory(this.allowedPDSDomainSchema),\n            createOrUpdate: createOrUpdateOrganizationInfoFactory(\n              this.allowedPDSDomainSchema\n            ),\n          },\n          site: {\n            get: getSiteFactory(this.allowedPDSDomainSchema),\n            getAll: getAllSitesFactory(this.allowedPDSDomainSchema),\n            create: createSiteFactory(this.allowedPDSDomainSchema),\n            update: updateSiteFactory(this.allowedPDSDomainSchema),\n            delete: deleteSiteFactory(this.allowedPDSDomainSchema),\n            getDefault: getDefaultProjectSiteFactory(\n              this.allowedPDSDomainSchema\n            ),\n            setDefault: setDefaultSiteFactory(this.allowedPDSDomainSchema),\n          },\n          measuredTrees: {\n            get: getMeasuredTreesFactory(this.allowedPDSDomainSchema),\n          },\n        },\n      },\n      hypercerts: {\n        claim: {\n          activity: {\n            create: createClaimActivityFactory(this.allowedPDSDomainSchema),\n            getAllAcrossOrgs: getAllClaimActivitiesAcrossOrganizationsFactory(\n              this.allowedPDSDomainSchema\n            ),\n            get: getCliamActivityFactory(this.allowedPDSDomainSchema),\n          },\n        },\n        location: {\n          get: getCertifiedLocationFactory(this.allowedPDSDomainSchema),\n        },\n      },\n    });\n  }\n\n  getServerCaller = () => {\n    return this.appRouter.createCaller(\n      async () =>\n        await createContext({ allowedPDSDomains: this.allowedPDSDomains })\n    );\n  };\n}\n\nexport type AppRouter<T extends SupportedPDSDomain> =\n  AppRouterFactory<T>[\"appRouter\"];\n"],"mappings":"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","names":["import_zod","superjson","import_server","file","z","import_session","import_trpc","import_api","import_server","import_zod","z","import_session","import_trpc","import_server","import_zod","z","import_session","import_trpc","import_zod","z","import_trpc","import_zod","import_agent","import_server","import_trpc","import_zod","import_agent","import_lex_api","import_validate_record_or_throw","import_trpc","import_zod","import_lex_api","import_agent","import_validate_record_or_throw","z","import_trpc","import_zod","import_lex_api","import_agent","import_validate_record_or_throw","z","MeasuredTreesCluster","import_trpc","import_zod","import_server","import_lex_api","import_blobref","import_file","import_agent","import_validate_record_or_throw","file","z","import_trpc","import_zod","import_lex_api","import_server","import_agent","import_file","import_blobref","import_validate_record_or_throw","z","import_trpc","import_zod","import_server","import_lex_api","import_tryCatch","import_xrpc","import_agent","import_classify_xrpc_error","import_validate_record_or_throw","import_trpc","import_zod","import_agent","import_lex_api","import_file","import_server","import_server","import_validate","import_tryCatch","file","file","import_trpc","import_zod","import_agent","import_lex_api","import_blobref","import_file","import_server","file","import_trpc","import_zod","import_lex_api","import_agent","import_server","import_parseAtUri","import_validate_record_or_throw","z","parseAtUri","import_lex_api","import_trpc","import_agent","import_server","import_zod","import_validate_record_or_throw","z","import_tryCatch","import_trpc","import_agent","import_zod","import_server","import_trpc","import_zod","import_server","import_lex_api","import_tryCatch","import_xrpc","import_agent","import_classify_xrpc_error","import_validate_record_or_throw","activitiesFetchError","import_trpc","import_zod","import_tryCatch","import_xrpc","import_lex_api","import_agent","import_classify_xrpc_error","import_server","import_validate_record_or_throw","import_trpc","import_zod","import_tryCatch","import_xrpc","import_lex_api","import_agent","import_classify_xrpc_error","import_server","import_validate_record_or_throw","import_zod","z"]}