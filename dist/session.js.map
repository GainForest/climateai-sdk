{"version":3,"sources":["../src/_internal/oauth/iron-session/config.ts","../src/_internal/oauth/iron-session/helpers.ts"],"names":[],"mappings":";;;;;;AAmBA,IAAM,eAAA,GAAkB,EAAA,GAAK,EAAA,GAAK,EAAA,GAAK,EAAA;AAKvC,IAAM,mBAAA,GAAsB,mBAAA;AAiBrB,SAAS,iBAAA,GAAoC;AAClD,EAAA,MAAM,YAAA,GAAe,QAAQ,GAAA,CAAI,aAAA;AAEjC,EAAA,IAAI,CAAC,YAAA,EAAc;AACjB,IAAA,MAAM,IAAI,KAAA;AAAA,MACR;AAAA,KACF;AAAA,EACF;AAEA,EAAA,IAAI,YAAA,CAAa,SAAS,EAAA,EAAI;AAC5B,IAAA,MAAM,IAAI,MAAM,mDAAmD,CAAA;AAAA,EACrE;AAEA,EAAA,OAAO;AAAA,IACL,QAAA,EAAU,YAAA;AAAA,IACV,UAAA,EAAY,OAAA,CAAQ,GAAA,CAAI,WAAA,IAAe,mBAAA;AAAA,IACvC,aAAA,EAAe;AAAA,MACb,QAAA,EAAU,IAAA;AAAA,MACV,MAAA,EAAQ,OAAA,CAAQ,GAAA,CAAI,QAAA,KAAa,YAAA;AAAA,MACjC,QAAA,EAAU,KAAA;AAAA,MACV,MAAA,EAAQ,eAAA;AAAA,MACR,IAAA,EAAM;AAAA;AACR,GACF;AACF;;;AC9CA,eAAsB,aAAA,GAAyC;AAC7D,EAAA,MAAM,WAAA,GAAc,MAAM,OAAA,EAAQ;AAClC,EAAA,MAAM,UAAU,MAAM,cAAA;AAAA,IACpB,WAAA;AAAA,IACA,iBAAA;AAAkB,GACpB;AAEA,EAAA,OAAO;AAAA,IACL,KAAK,OAAA,CAAQ,GAAA;AAAA,IACb,QAAQ,OAAA,CAAQ,MAAA;AAAA,IAChB,UAAA,EAAY,QAAQ,UAAA,IAAc;AAAA,GACpC;AACF;AAmBA,eAAsB,eACpB,IAAA,EACe;AACf,EAAA,MAAM,WAAA,GAAc,MAAM,OAAA,EAAQ;AAClC,EAAA,MAAM,UAAU,MAAM,cAAA;AAAA,IACpB,WAAA;AAAA,IACA,iBAAA;AAAkB,GACpB;AAEA,EAAA,IAAI,IAAA,CAAK,QAAQ,MAAA,EAAW;AAC1B,IAAA,OAAA,CAAQ,MAAM,IAAA,CAAK,GAAA;AAAA,EACrB;AACA,EAAA,IAAI,IAAA,CAAK,WAAW,MAAA,EAAW;AAC7B,IAAA,OAAA,CAAQ,SAAS,IAAA,CAAK,MAAA;AAAA,EACxB;AACA,EAAA,IAAI,IAAA,CAAK,eAAe,MAAA,EAAW;AACjC,IAAA,OAAA,CAAQ,aAAa,IAAA,CAAK,UAAA;AAAA,EAC5B;AAEA,EAAA,MAAM,QAAQ,IAAA,EAAK;AACrB;AAcA,eAAsB,eAAA,GAAiC;AACrD,EAAA,MAAM,WAAA,GAAc,MAAM,OAAA,EAAQ;AAClC,EAAA,MAAM,UAAU,MAAM,cAAA;AAAA,IACpB,WAAA;AAAA,IACA,iBAAA;AAAkB,GACpB;AAEA,EAAA,OAAA,CAAQ,OAAA,EAAQ;AAClB","file":"session.js","sourcesContent":["import type { SessionOptions } from \"iron-session\";\n\n/**\n * Session data stored in the iron-session cookie.\n * This contains minimal user identification data - full OAuth tokens\n * are stored in the Supabase session store.\n */\nexport type AppSessionData = {\n  /** User's DID (Decentralized Identifier) */\n  did?: string;\n  /** User's handle (e.g., \"user.climateai.org\") */\n  handle?: string;\n  /** Whether the user is currently logged in */\n  isLoggedIn: boolean;\n};\n\n/**\n * Default cookie expiration time in seconds (30 days)\n */\nconst DEFAULT_MAX_AGE = 60 * 60 * 24 * 30;\n\n/**\n * Default cookie name if not specified in environment\n */\nconst DEFAULT_COOKIE_NAME = \"climateai_session\";\n\n/**\n * Gets the iron-session configuration options.\n * Reads from environment variables:\n * - COOKIE_SECRET: Required, minimum 32 characters\n * - COOKIE_NAME: Optional, defaults to \"climateai_session\"\n *\n * @throws Error if COOKIE_SECRET is not set\n *\n * @example\n * ```typescript\n * // Set in .env\n * COOKIE_SECRET=your-secret-key-at-least-32-characters-long\n * COOKIE_NAME=greenglobe_session\n * ```\n */\nexport function getSessionOptions(): SessionOptions {\n  const cookieSecret = process.env.COOKIE_SECRET;\n\n  if (!cookieSecret) {\n    throw new Error(\n      \"COOKIE_SECRET environment variable is required for iron-session\"\n    );\n  }\n\n  if (cookieSecret.length < 32) {\n    throw new Error(\"COOKIE_SECRET must be at least 32 characters long\");\n  }\n\n  return {\n    password: cookieSecret,\n    cookieName: process.env.COOKIE_NAME || DEFAULT_COOKIE_NAME,\n    cookieOptions: {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"lax\" as const,\n      maxAge: DEFAULT_MAX_AGE,\n      path: \"/\",\n    },\n  };\n}\n","import { getIronSession } from \"iron-session\";\nimport { cookies } from \"next/headers\";\nimport { getSessionOptions, type AppSessionData } from \"./config\";\n\n/**\n * Gets the current app session from the iron-session cookie.\n * Returns the session data if a valid session exists, or a default empty session.\n *\n * @returns The current session data\n *\n * @example\n * ```typescript\n * const session = await getAppSession();\n * if (session.isLoggedIn && session.did) {\n *   // User is authenticated\n *   const oauthSession = await sdk.restoreSession(session.did);\n * }\n * ```\n */\nexport async function getAppSession(): Promise<AppSessionData> {\n  const cookieStore = await cookies();\n  const session = await getIronSession<AppSessionData>(\n    cookieStore,\n    getSessionOptions()\n  );\n\n  return {\n    did: session.did,\n    handle: session.handle,\n    isLoggedIn: session.isLoggedIn ?? false,\n  };\n}\n\n/**\n * Saves user data to the iron-session cookie.\n * Call this after successful OAuth callback to persist the user's identity.\n *\n * @param data - The session data to save (did, handle, isLoggedIn)\n *\n * @example\n * ```typescript\n * // After OAuth callback\n * const oauthSession = await sdk.callback(params);\n * await saveAppSession({\n *   did: oauthSession.sub,\n *   handle: oauthSession.handle,\n *   isLoggedIn: true,\n * });\n * ```\n */\nexport async function saveAppSession(\n  data: Partial<AppSessionData>\n): Promise<void> {\n  const cookieStore = await cookies();\n  const session = await getIronSession<AppSessionData>(\n    cookieStore,\n    getSessionOptions()\n  );\n\n  if (data.did !== undefined) {\n    session.did = data.did;\n  }\n  if (data.handle !== undefined) {\n    session.handle = data.handle;\n  }\n  if (data.isLoggedIn !== undefined) {\n    session.isLoggedIn = data.isLoggedIn;\n  }\n\n  await session.save();\n}\n\n/**\n * Clears the iron-session cookie, logging the user out.\n * Note: This only clears the cookie - the OAuth session in Supabase\n * should be cleared separately if needed.\n *\n * @example\n * ```typescript\n * // On logout\n * await clearAppSession();\n * // Optionally also clear the OAuth session from Supabase\n * ```\n */\nexport async function clearAppSession(): Promise<void> {\n  const cookieStore = await cookies();\n  const session = await getIronSession<AppSessionData>(\n    cookieStore,\n    getSessionOptions()\n  );\n\n  session.destroy();\n}\n\nexport type { AppSessionData };\n"]}