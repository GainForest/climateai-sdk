{"version":3,"sources":["../../../src/server/session.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { SignJWT, jwtVerify } from \"jose\";\nimport type { JwtPayload } from \"@atproto/oauth-client-node\";\nimport type { SupportedPDSDomain } from \"@/index\";\n\nexport interface StoredSession extends JwtPayload {\n  accessJwt: string;\n  refreshJwt: string;\n  did: string;\n  handle: string;\n}\n\nconst SECRET_KEY = new TextEncoder().encode(\n  process.env.COOKIE_SECRET || \"your-secret-key-min-32-chars-long\"\n);\n\nasync function encrypt(payload: StoredSession): Promise<string> {\n  return await new SignJWT(payload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(\"30d\")\n    .sign(SECRET_KEY);\n}\n\nasync function decrypt(token: string): Promise<StoredSession | null> {\n  try {\n    const { payload } = await jwtVerify(token, SECRET_KEY);\n    return payload as StoredSession;\n  } catch {\n    return null;\n  }\n}\n\nexport async function getSessionFromRequest(\n  service: SupportedPDSDomain = \"climateai.org\"\n): Promise<StoredSession | null> {\n  const cookieStore = await cookies();\n  const encryptedSession = cookieStore.get(`${service}_session`);\n\n  if (!encryptedSession) {\n    return null;\n  }\n\n  return await decrypt(encryptedSession.value);\n}\n\nexport async function saveSession(\n  session: StoredSession,\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  const encrypted = await encrypt(session);\n\n  cookieStore.set(`${service}_session`, encrypted, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 60 * 60 * 24 * 30,\n    path: \"/\",\n  });\n\n  return encrypted;\n}\n\nexport async function clearSession(\n  service: SupportedPDSDomain = \"climateai.org\"\n) {\n  const cookieStore = await cookies();\n  cookieStore.delete(`${service}_session`);\n}\n"],"mappings":";AAAA,SAAS,eAAe;AACxB,SAAS,SAAS,iBAAiB;AAWnC,IAAM,aAAa,IAAI,YAAY,EAAE;AAAA,EACnC,QAAQ,IAAI,iBAAiB;AAC/B;AAEA,eAAe,QAAQ,SAAyC;AAC9D,SAAO,MAAM,IAAI,QAAQ,OAAO,EAC7B,mBAAmB,EAAE,KAAK,QAAQ,CAAC,EACnC,YAAY,EACZ,kBAAkB,KAAK,EACvB,KAAK,UAAU;AACpB;AAEA,eAAe,QAAQ,OAA8C;AACnE,MAAI;AACF,UAAM,EAAE,QAAQ,IAAI,MAAM,UAAU,OAAO,UAAU;AACrD,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,eAAsB,sBACpB,UAA8B,iBACC;AAC/B,QAAM,cAAc,MAAM,QAAQ;AAClC,QAAM,mBAAmB,YAAY,IAAI,GAAG,OAAO,UAAU;AAE7D,MAAI,CAAC,kBAAkB;AACrB,WAAO;AAAA,EACT;AAEA,SAAO,MAAM,QAAQ,iBAAiB,KAAK;AAC7C;AAEA,eAAsB,YACpB,SACA,UAA8B,iBAC9B;AACA,QAAM,cAAc,MAAM,QAAQ;AAClC,QAAM,YAAY,MAAM,QAAQ,OAAO;AAEvC,cAAY,IAAI,GAAG,OAAO,YAAY,WAAW;AAAA,IAC/C,UAAU;AAAA,IACV,QAAQ,QAAQ,IAAI,aAAa;AAAA,IACjC,UAAU;AAAA,IACV,QAAQ,KAAK,KAAK,KAAK;AAAA,IACvB,MAAM;AAAA,EACR,CAAC;AAED,SAAO;AACT;AAEA,eAAsB,aACpB,UAA8B,iBAC9B;AACA,QAAM,cAAc,MAAM,QAAQ;AAClC,cAAY,OAAO,GAAG,OAAO,UAAU;AACzC;","names":[]}